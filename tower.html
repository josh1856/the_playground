<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Tower Forge ‚Äî Touch Defense</title>
<style>
  :root{--bg:#0b0f14;--panel:#101722;--ink:#e6edf3;--muted:#9aa4b2;--accent:#5ac8fa}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #1c2330;background:linear-gradient(180deg,#0f141d,#0c1118)}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#0d1421;border:1px solid #1f2a3b;color:#c7d2de;font-weight:600}
  #stage{position:relative}
  canvas{display:block;width:100%;height:100%;touch-action:none;background:radial-gradient(60% 50% at 50% 40%,#0c121a 0%,#081018 65%,#060b12 100%)}
  footer{border-top:1px solid #1c2330;background:#101722;padding:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  button{background:#0f1522;color:#e6edf3;border:1px solid #263247;padding:10px 12px;border-radius:12px;cursor:pointer}
  button.primary{border-color:var(--accent)}
  #hint{position:absolute;left:10px;bottom:10px;color:#9aa4b2;background:rgba(10,14,20,.6);border:1px solid #1c2330;border-radius:10px;padding:8px 10px}
  #toast{position:absolute;right:10px;bottom:10px;padding:8px 10px;border-radius:10px;background:rgba(20,28,40,.9);border:1px solid #253248;opacity:0;transform:translateY(8px);transition:.25s}
  #toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div><strong>Tower Forge</strong> <span style="color:#9aa4b2">‚Äî tap to place towers</span></div>
    <div class="stats">
      <span class="pill">‚ù§Ô∏è <span id="hearts">20</span></span>
      <span class="pill">üí∞ $<span id="coins">150</span></span>
      <span class="pill">üåä Wave <span id="wave">1</span></span>
      <span class="pill">‚ö° <span id="fps">60</span> fps</span>
    </div>
  </header>

  <div id="stage">
    <canvas id="cv"></canvas>
    <div id="hint">Tap a dark tile to place a tower ‚Ä¢ Pinch to zoom ‚Ä¢ Drag to pan</div>
    <div id="toast"></div>
  </div>

  <footer>
    <button id="t_basic" class="primary">Basic ($50)</button>
    <button id="t_slow">Frost ($60)</button>
    <button id="t_splash">Splash ($80)</button>
    <button id="start" class="primary">‚ñ∂ Start Wave</button>
    <button id="sell">Sell (tap tower)</button>
    <a href="index.html" style="margin-left:auto;color:#9aa4b2;align-self:center;text-decoration:none">‚üµ Home</a>
  </footer>
</div>

<script>
(function(){
  // Show real error text on iPhone while we iterate
  window.onerror = function(m,s,l){ alert('Error: '+m+(s?('\n'+s+':'+l):'')); };

  /* ===== Globals (use var to avoid Safari TDZ) ===== */
  var cv = document.getElementById('cv');
  var ctx = cv.getContext('2d',{alpha:false});
  var W=0, H=0, dpr=Math.min(2, window.devicePixelRatio||1);
  var panX=0, panY=0, zoom=1;
  var COLS=18, ROWS=10, TS=64;
  var grid = Array.from({length:ROWS},()=>Array(COLS).fill(0));
  var path = [];
  var ui = {
    hearts: document.getElementById('hearts'),
    coins : document.getElementById('coins'),
    wave  : document.getElementById('wave'),
    fps   : document.getElementById('fps'),
    toast : document.getElementById('toast')
  };
  var coins=150, lives=20, wave=1, running=false;
  var towers=[], bullets=[], mobs=[], particles=[], ripples=[];
  var selected='basic', selectedTower=null;

  /* ===== Helpers ===== */
  function toast(msg){ ui.toast.textContent=msg; ui.toast.classList.add('show'); setTimeout(function(){ui.toast.classList.remove('show');},1200); }
  function toWorld(x,y){ return [(x-panX)/zoom,(y-panY)/zoom]; }
  function dist(a,b){ var dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }
  function centerBoard(){ var bw=COLS*TS, bh=ROWS*TS; panX=(W-bw)/2; panY=(H-bh)/2; }

  /* ===== Size / setup ===== */
  function resize(){
    W = cv.clientWidth = cv.parentElement.clientWidth;
    H = cv.clientHeight = Math.max(360, window.innerHeight-140);
    cv.width = W*dpr; cv.height = H*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    centerBoard();
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  /* ===== Path ===== */
  (function makePath(){
    var r=1,c=0,dir=1;
    while(c<COLS){
      grid[r][c]=1; path.push({c:c,r:r});
      r+=dir;
      if(r===ROWS-2 || r===1){
        grid[r][c]=1; path.push({c:c,r:r});
        c++; if(c<COLS){ grid[r][c]=1; path.push({c:c,r:r}); }
        dir*=-1;
      }
    }
  })();
  var startCell = path[0];

  /* ===== Towers ===== */
  var T_DEF = {
    basic : {cost:50, range:150, rof:0.60, dmg:14, color:'#74c0fc'},
    slow  : {cost:60, range:130, rof:0.80, dmg: 8, color:'#9ae6ff', slow:0.45, sDur:1.4},
    splash: {cost:80, range:120, rof:0.90, dmg:10, color:'#ffd166', splash:70}
  };

  function addTower(col,row){
    if(grid[row][col]!==0){ toast('Can‚Äôt build on path'); return; }
    var def=T_DEF[selected];
    if(coins<def.cost){ toast('Not enough $'); return; }
    coins-=def.cost; ui.coins.textContent=coins;
    var x=col*TS+TS/2, y=row*TS+TS/2;
    towers.push({x:x,y:y,col:col,row:row,type:selected,t:0,lvl:1,def:def});
    grid[row][col]=2;
  }
  function sellTower(t){
    if(!t) return;
    coins += Math.round(T_DEF[t.type].cost*0.6);
    ui.coins.textContent=coins;
    grid[t.row][t.col]=0;
    towers.splice(towers.indexOf(t),1);
    selectedTower=null;
    toast('Sold');
  }
  function selectTower(t){ selectedTower=t; }

  /* ===== Mobs / waves ===== */
  function makeMob(hp,speed){
    var x=startCell.c*TS+TS/2, y=startCell.r*TS+TS/2;
    return {x:x, y:y, v:speed, hp:hp, max:hp, cellIndex:0, slowT:0};
  }
  function spawnWave(mult){
    if(mult==null) mult=1;
    running=true;
    var n=Math.round(10 + wave*2.5*mult), i=0;
    var timer=setInterval(function(){
      mobs.push(makeMob(60+wave*22, 55+Math.min(120, wave*2)));
      if(++i>=n) clearInterval(timer);
    }, 380);
  }

  /* ===== Input ===== */
  var dragging=false, lastTouchDist=0, lastX=0, lastY=0;
  function addRipple(sx,sy){ ripples.push({sx:sx, sy:sy, t:0}); }

  cv.addEventListener('pointerdown', function(e){ dragging=true; lastX=e.clientX; lastY=e.clientY; });
  cv.addEventListener('pointerup', function(e){
    if(Math.hypot ? Math.hypot(e.clientX-lastX, e.clientY-lastY)<8
                  : (function(dx,dy){return Math.sqrt(dx*dx+dy*dy)<8;})(e.clientX-lastX,e.clientY-lastY)){
      onTap(e.clientX,e.clientY); addRipple(e.clientX,e.clientY);
    }
    dragging=false;
  });
  cv.addEventListener('pointermove', function(e){
    if(dragging){ panX+=e.clientX-lastX; panY+=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; }
  });
  cv.addEventListener('touchstart', function(e){
    if(e.touches.length===1){ var t=e.touches[0]; onTap(t.clientX,t.clientY); addRipple(t.clientX,t.clientY); }
  }, {passive:true});
  cv.addEventListener('touchmove', function(e){
    if(e.touches.length===2){
      var dx=e.touches[0].clientX-e.touches[1].clientX;
      var dy=e.touches[0].clientY-e.touches[1].clientY;
      var d=Math.sqrt(dx*dx+dy*dy);
      if(lastTouchDist){ var k=d/lastTouchDist; zoom=Math.max(0.6, Math.min(2, zoom*k)); }
      lastTouchDist=d;
    }else if(e.touches.length===1 && dragging){
      var t=e.touches[0]; panX+=t.clientX-lastX; panY+=t.clientY-lastY; lastX=t.clientX; lastY=t.clientY;
    }
  }, {passive:true});
  cv.addEventListener('touchend', function(){ lastTouchDist=0; }, {passive:true});

  function onTap(cx,cy){
    var w=toWorld(cx,cy), wx=w[0], wy=w[1];
    var col=Math.floor(wx/TS), row=Math.floor(wy/TS);
    if(col<0||col>=COLS||row<0||row>=ROWS) return;

    var existing=towers.find ? towers.find(function(t){return t.col===col&&t.row===row;})
                             : (function(){for(var i=0;i<towers.length;i++){var t=towers[i];if(t.col===col&&t.row===row)return t;} return null;})();
    if(existing){
      selectTower(existing);
      var upCost=Math.round(T_DEF[existing.type].cost*0.7*existing.lvl);
      if(coins>=upCost){
        coins-=upCost; ui.coins.textContent=coins;
        existing.lvl++;
        existing.def = Object.assign({}, existing.def, {dmg:existing.def.dmg*1.25, range:existing.def.range+8});
        toast('Upgraded');
      }else{
        toast('Tap SELL to refund');
      }
      return;
    }
    addTower(col,row);
  }

  /* ===== Combat ===== */
  function makeBurst(x,y,color){ return {x:x,y:y,t:0,color:color}; }
  function makeBullet(x,y,tx,ty,tower){
    var a=Math.atan2(ty-y,tx-x), sp=360;
    return {x:x, y:y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp,
            dmg:tower.def.dmg*tower.lvl, splash:tower.def.splash||0,
            slow:tower.def.slow?{k:tower.def.slow,dur:tower.def.sDur}:null,
            life:1.2, color:tower.def.color};
  }

  function update(dt){
    // mobs
    for(var i=mobs.length-1;i>=0;i--){
      var m=mobs[i], seg=path[m.cellIndex+1];
      if(!seg){
        mobs.splice(i,1);
        lives--; ui.hearts.textContent=lives;
        particles.push(makeBurst(m.x,m.y,'#ff6b6b'));
        if(lives<=0) resetGame();
        continue;
      }
      var tx=seg.c*TS+TS/2, ty=seg.r*TS+TS/2;
      var s=(m.slowT>0?0.5:1)*m.v*dt, dx=tx-m.x, dy=ty-m.y, d=Math.sqrt(dx*dx+dy*dy);
      if(d<s){ m.x=tx; m.y=ty; m.cellIndex++; } else { m.x+=dx/d*s; m.y+=dy/d*s; }
      if(m.slowT>0) m.slowT-=dt;
      if(m.hp<=0){
        coins+=8; ui.coins.textContent=coins;
        particles.push(makeBurst(m.x,m.y,'#a0ff90'));
        mobs.splice(i,1);
      }
    }

    // towers fire
    for(var j=0;j<towers.length;j++){
      var t=towers[j]; t.t+=dt; var def=t.def;
      if(t.t>=def.rof){
        var best=null, bd=1e9;
        for(var k=0;k<mobs.length;k++){ var mm=mobs[k]; var dd=dist(t,mm); if(dd<=def.range && dd<bd){ best=mm; bd=dd; } }
        if(best){ bullets.push(makeBullet(t.x,t.y,best.x,best.y,t)); t.t=0; }
      }
    }

    // bullets
    for(i=bullets.length-1;i>=0;i--){
      var b=bullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt;
      if(b.life<=0){ bullets.splice(i,1); continue; }
      var hit=null, minD=12;
      for(j=0;j<mobs.length;j++){ var m2=mobs[j]; var d2=dist(b,m2); if(d2<minD){ hit=m2; minD=d2; break; } }
      if(hit){
        if(b.splash>0){
          for(j=0;j<mobs.length;j++){
            var m3=mobs[j]; var d3=dist(b,m3);
            if(d3<=b.splash){
              m3.hp -= b.dmg*(1-d3/b.splash*0.6);
              if(b.slow){ m3.slowT=Math.max(m3.slowT,b.slow.dur); m3.v=Math.max(40, m3.v*b.slow.k); }
            }
          }
        }else{
          hit.hp -= b.dmg;
          if(b.slow){ hit.slowT=Math.max(hit.slowT,b.slow.dur); hit.v=Math.max(40, hit.v*b.slow.k); }
        }
        particles.push(makeBurst(b.x,b.y,b.color));
        bullets.splice(i,1);
      }
    }

    // particles
    for(i=particles.length-1;i>=0;i--){
      particles[i].t+=dt; if(particles[i].t>0.6) particles.splice(i,1);
    }
  }

  /* ===== Render ===== */
  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.save(); ctx.translate(panX,panY); ctx.scale(zoom,zoom);

    // board (bright tiles + subtle grid)
    for(var r=0;r<ROWS;r++){
      for(var c=0;c<COLS;c++){
        var x=c*TS, y=r*TS;
        ctx.fillStyle = (grid[r][c]===1) ? '#1f2b3e' : '#121b2a';
        ctx.fillRect(x,y,TS-1,TS-1);
        ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.strokeRect(x+0.5,y+0.5,TS-1,TS-1);
      }
    }

    // towers
    for(var i=0;i<towers.length;i++){
      var t=towers[i];
      var g=ctx.createRadialGradient(t.x,t.y,6,t.x,t.y,26);
      g.addColorStop(0,t.def.color); g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(t.x,t.y,26,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#e6edf3'; ctx.beginPath(); ctx.arc(t.x,t.y,10,0,Math.PI*2); ctx.fill();
      ctx.fillStyle=t.def.color; ctx.beginPath(); ctx.arc(t.x,t.y,6,0,Math.PI*2); ctx.fill();
      if(selectedTower===t){ ctx.strokeStyle=t.def.color; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(t.x,t.y,t.def.range,0,Math.PI*2); ctx.stroke(); }
    }

    // mobs
    for(i=0;i<mobs.length;i++){
      var m=mobs[i], hp=m.hp/m.max;
      var body=ctx.createRadialGradient(m.x,m.y,2,m.x,m.y,12);
      body.addColorStop(0,'#ff8f8f'); body.addColorStop(1,'#751f2b');
      ctx.fillStyle=body; ctx.beginPath(); ctx.arc(m.x,m.y,10,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(m.x-12,m.y-16,24,4);
      ctx.fillStyle='#6df26d'; ctx.fillRect(m.x-12,m.y-16,24*hp,4);
    }

    // bullets
    for(i=0;i<bullets.length;i++){
      var b=bullets[i];
      ctx.strokeStyle=b.color; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(b.x-b.vx*0.05,b.y-b.vy*0.05); ctx.lineTo(b.x,b.y); ctx.stroke();
      ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,2.5,0,Math.PI*2); ctx.fill();
    }

    // particles
    for(i=0;i<particles.length;i++){
      var p=particles[i]; var a=1-p.t/0.6;
      ctx.fillStyle='rgba(255,255,255,'+(a*0.5)+')';
      for(var k=0;k<6;k++){ var ang=k*Math.PI/3; ctx.fillRect(p.x+Math.cos(ang)*p.t*90, p.y+Math.sin(ang)*p.t*90,2,2); }
      ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,8*a,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // tap ripples (screen space)
    for(i=ripples.length-1;i>=0;i--){
      var rp=ripples[i]; rp.t+=0.02; var aa=1-rp.t; if(aa<=0){ ripples.splice(i,1); continue; }
      var k2=20+rp.t*40; ctx.save(); ctx.strokeStyle='rgba(90,200,250,'+aa+')'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(rp.sx,rp.sy,k2,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }
  }

  /* ===== Loop / FPS ===== */
  var last=performance.now(), acc=0, frames=0;
  function tick(t){
    var dt=Math.min(0.05,(t-last)/1000); last=t;
    if(running) update(dt); draw();
    frames++; acc+=dt; if(acc>0.4){ ui.fps.textContent=Math.round(frames/acc); frames=0; acc=0; }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  /* ===== Reset & auto-start ===== */
  function resetGame(){
    running=false; toast('Game over! Tap Start to try again');
    lives=20; coins=150; wave=1;
    ui.hearts.textContent=lives; ui.coins.textContent=coins; ui.wave.textContent=wave;
    mobs.length=towers.length=bullets.length=particles.length=0;
    for(var r=0;r<ROWS;r++) for(var c=0;c<COLS;c++) if(grid[r][c]===2) grid[r][c]=0;
  }
  document.getElementById('t_basic').onclick  = function(){ selected='basic';  selectTower(null); };
  document.getElementById('t_slow').onclick   = function(){ selected='slow';   selectTower(null); };
  document.getElementById('t_splash').onclick = function(){ selected='splash'; selectTower(null); };
  document.getElementById('sell').onclick     = function(){ sellTower(selectedTower); };
  document.getElementById('start').onclick    = function(){ if(!running) spawnWave(1); };

  // Auto-start first wave after 3s so the screen never looks idle
  setTimeout(function(){ if(!running){ spawnWave(1); toast('Auto-starting wave 1'); } }, 3000);
})();
</script>
</body>
</html>